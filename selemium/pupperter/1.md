### Tutorial Completo de Puppeteer en Español

Puppeteer es una biblioteca de automatización para Node.js que permite controlar navegadores web sin cabeza (headless) o con interfaz gráfica, como Chrome o Chromium, a través de un protocolo de bajo nivel llamado DevTools. En este tutorial, aprenderemos desde los conceptos básicos hasta ejemplos prácticos avanzados.

#### 1. **Instalación de Puppeteer**

Para empezar, debes tener Node.js instalado en tu sistema. Luego, instala Puppeteer utilizando el siguiente comando:

```bash
npm install puppeteer
```

#### 2. **Conceptos Básicos**

Puppeteer te permite trabajar con navegadores de dos maneras principales:
- **Lanzando un nuevo navegador**: Puppeteer puede lanzar un navegador Chrome o Chromium en modo sin cabeza.
- **Conectándose a un navegador existente**: Puedes controlar un navegador que ya está en ejecución.

### 3. **Lanzamiento de un Navegador**

Para lanzar un nuevo navegador, importa Puppeteer y utiliza el método `launch()`:

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.launch(); // Lanza un navegador sin cabeza por defecto
  const page = await browser.newPage(); // Abre una nueva pestaña
  await page.goto('https://example.com'); // Navega a la URL indicada
  console.log(await page.title()); // Muestra el título de la página
  await browser.close(); // Cierra el navegador
})();
```

Puedes lanzar el navegador con interfaz gráfica cambiando la opción `headless`:

```javascript
const browser = await puppeteer.launch({ headless: false });
```

### 4. **Contextos del Navegador**

Los **BrowserContexts** permiten aislar tareas de automatización, lo que significa que no se comparten cookies ni almacenamiento local entre ellos.

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.launch();
  const context = await browser.createIncognitoBrowserContext(); // Crea un contexto en modo incógnito

  const page1 = await context.newPage();
  await page1.goto('https://example.com');

  const page2 = await context.newPage();
  await page2.goto('https://example.org');

  await context.close(); // Cierra todas las pestañas del contexto
  await browser.close();
})();
```

### 5. **Configuración de Permisos**

Puedes configurar los permisos para un contexto, por ejemplo, para simular la aceptación de permisos de geolocalización:

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.launch();
  const context = browser.defaultBrowserContext();

  await context.overridePermissions('https://html5demos.com', ['geolocation']);

  const page = await browser.newPage();
  await page.goto('https://html5demos.com');

  await browser.close();
})();
```

### 6. **Conexión a un Navegador en Ejecución**

Si has lanzado un navegador fuera de Puppeteer (por ejemplo, desde la línea de comandos con la opción `--remote-debugging-port`), puedes conectarte a él mediante el método `connect`:

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.connect({
    browserWSEndpoint: 'ws://127.0.0.1:9222/devtools/browser/...',
  });

  const page = await browser.newPage();
  await page.goto('https://example.com');
  
  await browser.disconnect(); // Desconecta Puppeteer del navegador
})();
```

> **Nota:** `browser.disconnect()` no cierra el navegador ni las pestañas, a diferencia de `browser.close()`.

### 7. **Ejemplos Prácticos**

#### Ejemplo 1: Tomar una Captura de Pantalla

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();
  
  await page.goto('https://example.com');
  await page.screenshot({ path: 'screenshot.png', fullPage: true }); // Captura de pantalla completa
  
  await browser.close();
})();
```

#### Ejemplo 2: Extraer el Texto de una Página Web

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  await page.goto('https://example.com');
  const texto = await page.evaluate(() => document.body.innerText);
  console.log(texto);
  
  await browser.close();
})();
```

#### Ejemplo 3: Rellenar un Formulario y Enviar

```javascript
import puppeteer from 'puppeteer';

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  
  await page.goto('https://example.com/login');
  
  // Rellena los campos del formulario
  await page.type('#username', 'mi_usuario');
  await page.type('#password', 'mi_contraseña');
  
  // Envía el formulario
  await page.click('#submit-button');
  
  await page.waitForNavigation(); // Espera a que la página termine de cargar
  
  console.log('Formulario enviado con éxito');
  await browser.close();
})();
```

### 8. **Buenas Prácticas**

- Utiliza `waitForSelector` para asegurarte de que un elemento esté presente en la página antes de interactuar con él.
- Siempre cierra el navegador después de terminar la ejecución para liberar recursos.
- Aprovecha el uso de **contextos de navegador** para ejecutar tareas aisladas.

### 9. **Conclusión**

Puppeteer es una herramienta poderosa para la automatización de navegadores. Desde realizar tareas simples como capturas de pantalla, hasta pruebas más complejas como la interacción con formularios o la simulación de permisos, Puppeteer facilita la automatización en navegadores modernos.