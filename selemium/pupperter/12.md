Para ejecutar Puppeteer en extensiones de Chrome, hay que tener en cuenta que el entorno de las extensiones es significativamente diferente al entorno usual de Node.js. Puppeteer en extensiones utiliza `chrome.debugger`, lo que restringe el acceso a la Chrome DevTools Protocol (CDP) y limita la interacción a una sola página a la vez. A continuación, te guiaré paso a paso para configurar y ejecutar Puppeteer en una extensión de Chrome.

### Paso 1: Crear el proyecto de la extensión

1. **Estructura del proyecto:**
   Crea una carpeta para tu extensión con la siguiente estructura:
   ```
   my-extension/
   ├── manifest.json
   ├── main.mjs
   ├── background.js
   └── popup.html
   ```

2. **Archivo `manifest.json`:** Define el manifiesto de la extensión.
   ```json
   {
     "manifest_version": 3,
     "name": "Puppeteer Extension",
     "version": "1.0",
     "permissions": [
       "debugger",
       "tabs",
       "activeTab"
     ],
     "background": {
       "service_worker": "background.js"
     },
     "action": {
       "default_popup": "popup.html",
       "default_icon": {
         "16": "icon16.png",
         "48": "icon48.png",
         "128": "icon128.png"
       }
     }
   }
   ```

### Paso 2: Configuración de Puppeteer

1. **Instalación de Puppeteer Core:**
   Ejecuta en tu terminal:
   ```
   npm install puppeteer-core
   ```

2. **Archivo `main.mjs`:** Este archivo se encargará de manejar Puppeteer.
   ```javascript
   import {
     connect,
     ExtensionTransport,
   } from 'puppeteer-core/lib/esm/puppeteer/puppeteer-core-browser.js';

   async function connectToTab(url) {
     // Crear una nueva pestaña
     const tab = await chrome.tabs.create({ url });

     // Conectar Puppeteer usando ExtensionTransport
     const browser = await connect({
       transport: await ExtensionTransport.connectTab(tab.id),
     });

     // Obtener la página activa
     const [page] = await browser.pages();
     console.log(await page.evaluate('document.title'));

     // Desconectar Puppeteer
     browser.disconnect();
   }

   // Exportar la función para que pueda ser usada en el archivo de fondo
   export { connectToTab };
   ```

### Paso 3: Configuración del empaquetado con Rollup

1. **Instalación de Rollup:**
   Ejecuta:
   ```
   npm install --save-dev rollup @rollup/plugin-node-resolve
   ```

2. **Archivo `rollup.config.js`:** Configuración para empaquetar Puppeteer para el navegador.
   ```javascript
   import { nodeResolve } from '@rollup/plugin-node-resolve';

   export default {
     input: 'main.mjs',
     output: {
       format: 'esm',
       dir: 'out',
     },
     external: ['chromium-bidi/lib/cjs/bidiMapper/BidiMapper.js'],
     plugins: [
       nodeResolve({
         browser: true,
         resolveOnly: ['puppeteer-core'],
       }),
     ],
   };
   ```

3. **Ejecuta Rollup:**
   Para generar el archivo empaquetado:
   ```
   npx rollup -c
   ```

### Paso 4: Implementación en `background.js`

1. **Archivo `background.js`:** Aquí importamos la función `connectToTab` y la llamamos cuando la extensión se activa.
   ```javascript
   import { connectToTab } from './out/main.js';

   chrome.action.onClicked.addListener((tab) => {
     connectToTab('https://example.com');
   });
   ```

### Paso 5: Archivo `popup.html` (opcional)

Crea un archivo simple para la interfaz emergente.
```html
<!DOCTYPE html>
<html>
<head>
    <title>Puppeteer Extension</title>
</head>
<body>
    <h1>Puppeteer Extension</h1>
    <button id="run">Ejecutar Puppeteer</button>
    <script src="background.js"></script>
</body>
</html>
```

### Paso 6: Carga la extensión en Chrome

1. Abre **chrome://extensions/** en tu navegador.
2. Activa el **Modo de desarrollador**.
3. Haz clic en **Cargar extensión sin empaquetar** y selecciona la carpeta del proyecto.

### Paso 7: Prueba la extensión

Haz clic en el icono de la extensión y deberías ver que se abre una nueva pestaña y Puppeteer interactúa con ella. Puedes modificar el código para realizar acciones específicas en la página, como capturar una captura de pantalla o extraer datos.

¡Y listo! Has configurado y ejecutado Puppeteer dentro de una extensión de Chrome. Puedes personalizar la extensión para realizar acciones automatizadas según tus necesidades.